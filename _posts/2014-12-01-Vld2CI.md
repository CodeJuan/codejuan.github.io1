---
layout: post
title: VLD集成到CI自动化检测内存泄露
comments: true
---

# VLD简介

> Visual Leak Detector is a free, robust, open-source memory leak detection system for Visual C++. 

windows下VC常用开源内存泄露检测工具，代码在[codeplex](http://vld.codeplex.com/)

## 原理
代码中include了vld.h，在开始运行时构建一个VisualLeakDetector g_vld的全局变量，接管申请内存和释放内存的操作。
此后会记录每次申请内存，并将地址及call stack存到一个set；
释放内存时会删除set中与之相匹配的内存申请记录。
在程序结束时，vld会遍历此set，如果set不为空，说明有内存泄露，会将泄露地址及call stack输出到report中。

## 简单用法
0. 下载及安装，假设安装在`VldPath`
1. 配置VC的include路径：右键-属性-directory-include directory，增加`VldPath\include`
2. 配置lib路径：右键-属性-directory-lib directory，，增加`VldPath\lib\win32`，如果是x64的系统，那么选择win64即可。
3. 根据需要配置vld.ini
4. 声明

{% highlight cpp %}  
#define VLD_FORCE_ENABLE    //2.3版本之后，支持release下检测内存泄露
#include "vld.h"
{% endhighlight %}  

5. 构建，运行，就会生成report。

# 集成到CI
其实就是用脚本来实现上面的步骤，由于项目暂时不允许上传lib和dll到svn，只能通过迂回的方法来实现。

## vld.h
项目中有一个专门的目录存放开源代码的头文件，此时正好派上用场
{% highlight bat %}  
copy /y vld.h %CODE_HOME%\opensrc\include\
:: /y表示默认覆盖同名文件
copy /y vld_def.h %CODE_HOME%\opensrc\include\
{% endhighlight %}  

## vld.lib
同样也有个存放开源代码lib的目录
{% highlight bat %}  
copy /y vld.lib %CODE_HOME%\opensrc\lib\
{% endhighlight %}  

## dll
将vld_x86.dll拷贝到bin目录
{% highlight bat %}  
copy /y vld_x86.dll %CODE_HOME%\bin\
{% endhighlight %}  

## vld.ini
将AggregateDuplicates设置为yes，表示将引起泄露同一行代码合并到一块。
将ReportFile设置为.\leak_report.txt，表示将结果输出到leak_report.txt中
再将ini拷贝到bin
{% highlight bat %}  
copy /y vld.ini %CODE_HOME%\bin\
{% endhighlight %} 

## 更新代码
svn revert -R .
svn update .

## 修改stdafx.h
由于stdafx.h会被预编译，只要在其包含vld.h，那么整个工程都会处于vld的监控之下。
{% highlight bat %}  
:: 家里没有windows的系统，凭记忆写的，可能会有点小纰漏
FOR /F "delims=" %%i IN('dir /b /s stdafx.h') DO(
    echo //>>"%%i"
    echo #define VLD_FORCE_ENABLE>>"%%i"
    echo #include "vld.h">>"%%i"
)
{% endhighlight %} 

## 

